<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Serenity</title>
  </head>
  <body>
    <script>
    safari.application.addEventListener("open", onOpen, true);

function isTab(e) {
  return e.target instanceof SafariBrowserTab;
}

function onOpen(e) {
  if (!isTab(e)) {
    return;
  }

  e.target.addEventListener("beforeNavigate", onBeforeNavigate, false);
  setTimeout(function() {
    e.target.removeEventListener("beforeNavigate", onBeforeNavigate, false);
    setNewTabContent(e.target);
  }, 50);
}

function toDateTime(secs) {
  var t = new Date(1970, 0, 1); // Epoch
  t.setSeconds(secs);
  return t;
}

function isExpired(date, expInterval) {
  if (!expInterval) {
    return;
  }

  var now = new Date().getTime();
  var result = now - date;
  var seconds = parseInt(result / 1000, 10);

  if (expInterval === "day") {
    var d = new Date();
    d.setHours(24, 0, 0, 0);
    var midnight = d.getTime();

    var diff = midnight - now;

    var tmrrw = new Date();
    tmrrw.setHours(24, 1, 0, 0);
    var tomorrow = tmrrw.getTime();

    return diff < 0;
  }

  if (expInterval === "hour" && seconds > 3600) {
    return true;
  }

  return false;
}

function get(url, cb, expInterval) {
  var cached = localStorage.getItem(url);
  if (!!cached) {
    var parsed = JSON.parse(cached);

    if (!isExpired(parsed.timestamp, expInterval)) {
      setTimeout(_ => {
        cb(parsed.value);
      }, 500);
      return;
    }
  }

  var xhr = new XMLHttpRequest();

  xhr.onerror = function(e) {
    console.log(xhr.status);
    console.log(xhr.statusText);
  };

  xhr.onload = function(e) {
    var item = { value: xhr.responseText, timestamp: new Date().getTime() };
    localStorage.setItem(url, JSON.stringify(item));
    cb(xhr.responseText);
  };

  xhr.open("GET", url, true);

  xhr.send();
}

function setNewTabContent(tab) {
  get(
    "https://reddit.com/r/earthporn.json",
    body => tab.page.dispatchMessage("background", body),
    "day"
  );

  get(
    "https://query.yahooapis.com/v1/public/yql?q=select%20item.condition%20from%20weather.forecast%20where%20woeid%20%3D%202487889&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys",
    body => tab.page.dispatchMessage("weather", body),
    "hour"
  );

  get(
    "http://quotes.rest/qod.json?category=inspire",
    body => tab.page.dispatchMessage("quote", body),
    "day"
  );

  tab.url = safari.extension.baseURI + "serenity.html";
}

function onBeforeNavigate(e) {
  if (!e.url) {
    return;
  }

  e.preventDefault();

  setNewTabContent(e.target);
}
</script>
  </body>
</html>
